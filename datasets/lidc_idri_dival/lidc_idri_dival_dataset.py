# -*- coding: utf-8 -*-
"""Provides `LIDCIDRIDivalDataset`."""
import os
import json
import numpy as np
from pydicom.filereader import dcmread
from odl.discr.lp_discr import uniform_discr
from dival.datasets.dataset import GroundTruthDataset

DATA_PATH = '/localdata/LIDC-IDRI'
FILE_LIST_FILE = ('/home/jleuschn/phd/dival/datasets/lidc_idri_dival/'
                  'lidc_idri_file_list.json')


class LIDCIDRIDivalDataset(GroundTruthDataset):
    """Dataset extracted from the `LIDC-IDRI dataset
    <http://doi.org/10.7937/K9/TCIA.2015.LO9QL9SX>`_.

    The selection of image files is determined by the accompanying json file.
    It was generated by the script ``create_file_list.py``.

    Each image is cropped to the centered rectangle of shape (362, 362).
    The values are clipped to [-1024, 3071] HU and normalized into [0., 1.] by
    the formula ``normalized = (original + 1024) / 4096``.
    """
    def __init__(self):
        self.shape = (362, 362)
        with open(FILE_LIST_FILE, 'r') as json_file:
            json_dict = json.load(json_file)
        self.train_dcm_files = json_dict['train']
        self.test_dcm_files = json_dict['test']
        self.train_len = len(self.train_dcm_files)
        self.test_len = len(self.test_dcm_files)

    def generator(self, test=False, min_pt=None, max_pt=None):
        """Yield selected cropped and normalized LIDC-IDRI images of shape
        (362, 362).

        Parameters
        ----------
        min_pt : [int, int], optional
            Minimum values of the lp space.
        max_pt : [int, int], optional
            Maximum values of the lp space.
        """
        MIN_VAL, MAX_VAL = -1024, 3071

        if min_pt is None:
            min_pt = [-self.shape[0]/2, -self.shape[1]/2]
        if max_pt is None:
            max_pt = [self.shape[0]/2, self.shape[1]/2]
        space = uniform_discr(min_pt, max_pt, self.shape, dtype=np.float32)

        r = np.random.RandomState(1 if test else 42)
        dcm_files = self.test_dcm_files if test else self.train_dcm_files
        for dcm_file in dcm_files:
            dataset = dcmread(os.path.join(DATA_PATH, dcm_file))

            # crop to largest rectangle in centered circle
            array = dataset.pixel_array[75:-75, 75:-75].astype(np.float32)

            # rescale by dicom meta info
            array *= dataset.RescaleSlope
            array += dataset.RescaleIntercept

            # add noise to get continuous values from discrete ones
            array += r.uniform(0., 1., size=array.shape)

            # normalize
            array -= MIN_VAL
            array /= MAX_VAL
            np.clip(array, 0., 1., out=array)

            image = space.element(array)

            yield image
